var PicoCadViewer=function(){"use strict";var t="undefined"!=typeof Float32Array?Float32Array:Array;function e(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),e();const r=[[0,0,0],[29,43,83],[126,37,83],[0,135,81],[171,82,54],[95,87,79],[194,195,199],[255,241,232],[255,0,77],[255,163,0],[255,236,39],[0,228,54],[41,173,255],[131,118,156],[255,119,168],[255,204,170]];class i{constructor(t,e={}){this.objects=t,this.name=e.name,this.backgroundIndex=e.backgroundIndex??0,this.alphaIndex=e.alphaIndex??0,this.zoomLevel=e.zoomLevel,this.texture=e.texture}backgroundColor(){return r[this.backgroundIndex]}alphaColor(){return r[this.alphaIndex]}textureAsImage(t){null==t&&(t=r);const e=new ImageData(128,128),i=e.data,n=this.texture,o=this.alphaIndex;let a=0,s=0;for(let e=0;e<120;e++)for(let e=0;e<128;e++){const e=n[a];if(e!==o){const r=t[e];i[s]=r[0],i[s+1]=r[1],i[s+2]=r[2],i[s+3]=255}a++,s+=4}return e}}class n{constructor(t,e,r,i,n){this.name=t,this.position=e,this.rotation=r,this.vertices=i,this.faces=n}}class o{constructor(t,e,r,i={}){this.indices=t,this.colorIndex=e,this.uvs=r,this.shading=i.shading??!0,this.texture=i.texture??!0,this.doubleSided=i.doubleSided??!1,this.renderFirst=i.renderFirst??!1}color(){return r[this.colorIndex]}}class a{constructor(t,e={}){this.gl=t,this.cull=e.cull??!0,this.shading=e.shading??!0,this.texture=e.texture??!0,this.clearDepth=e.clearDepth??!1,this.vertices=[],this.normals=[],this.uvs=[],this.colorUVs=[],this.triangles=[]}save(){const t=this.gl;this.vertexCount=this.triangles.length,this.isEmpty()||(this.vertexBuffer=t.createBuffer(),this.uvBuffer=t.createBuffer(),this.colorUVBuffer=t.createBuffer(),this.triangleBuffer=t.createBuffer(),this.shading&&(this.normalBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.uvs),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.colorUVBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.colorUVs),t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.triangleBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.triangles),t.STATIC_DRAW),this.shading&&(t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.normals),t.STATIC_DRAW))),this.uvs=null,this.colorUVs=null,this.normals=null,this.vertices=null,this.triangles=null}isEmpty(){return 0===this.vertexCount}free(){const t=this.gl;t.deleteBuffer(this.vertexBuffer),t.deleteBuffer(this.uvBuffer),t.deleteBuffer(this.colorUVBuffer),t.deleteBuffer(this.triangleBuffer),this.shading&&t.deleteBuffer(this.normalBuffer)}}class s{constructor(t){this.gl=t,this.vertices=[]}save(){const t=this.gl;this.vertexCount=Math.floor(this.vertices.length/3),this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),this.vertices=null}free(){this.gl.deleteBuffer(this.vertexBuffer)}}function h(t,e,r){const{passes:i,wireframe:n}=function(t,e,r){const i=[];for(let e=0;e<16;e++){const r=e%2<1,n=e%4<2,o=e%8<4;i.push(new a(t,{cull:!r,shading:n,texture:o,clearDepth:8===e}))}const n=new s(t),o=n.vertices;for(const t of e.objects){const e=t.position,n=t.vertices.map((t=>[-t[0]-e[0],-t[1]-e[1],t[2]+e[2]]));for(const e of t.faces){const t=e.indices,a=e.uvs,s=i[(e.doubleSided?0:1)+(e.shading?0:2)+(e.texture?0:4)+(e.renderFirst?0:8)],h=s.vertices,f=s.triangles,c=s.normals,g=s.uvs,d=s.colorUVs,m=.03125+e.colorIndex/16,x=0,_=Math.floor(h.length/3),p=[],T=[];for(let e=0;e<t.length;e++){const r=n[t[e]],i=n[t[0===e?t.length-1:e-1]],s=a[e];p.push(r),o.push(r[0],r[1],r[2],i[0],i[1],i[2]),T.push([s[0]/16,s[1]/16])}const v=u(p);if(4===t.length&&e.texture&&r>1){const t=p[0],e=p[1],i=p[2],n=p[3],o=T[0],a=T[1],s=T[2],u=T[3];for(let f=0;f<=r;f++){const _=f/r,p=[l(t[0],e[0],_),l(t[1],e[1],_),l(t[2],e[2],_),l(o[0],a[0],_),l(o[1],a[1],_)],T=[l(n[0],i[0],_),l(n[1],i[1],_),l(n[2],i[2],_),l(u[0],s[0],_),l(u[1],s[1],_)];for(let t=0;t<=r;t++){const e=t/r;h.push(l(p[0],T[0],e),l(p[1],T[1],e),l(p[2],T[2],e)),g.push(l(p[3],T[3],e),l(p[4],T[4],e)),d.push(m,x),c.push(v[0],v[1],v[2])}}for(let t=0;t<r;t++)for(let e=0;e<r;e++){const i=e*(r+1),n=_+i+t+1,o=_+i+t+r+1;f.push(_+i+t,n,o,o,n,_+i+t+r+2)}}else{for(const t of p)h.push(t[0],t[1],t[2]),c.push(v[0],v[1],v[2]);for(let t=0;t<T.length;t++)if(d.push(m,x),e.texture){const e=T[t];g.push(e[0],e[1])}else g.push(m,x);for(let e=0,r=t.length-2;e<r;e++)f.push(_+1+e,_,_+2+e)}}}for(const t of i)t.save();return n.save(),{passes:i,wireframe:n}}(t,e,r+1);return{passes:i,wireframe:n,textureIndices:function(t,e){const r=Array(16384).fill(255);for(let i=0;i<t.length;i++){const n=t[i];r[i]=n===e?255:n}for(let t=0;t<16;t++)r[16256+t]=t;return r}(e.texture,e.alphaIndex)}}function l(t,e,r){return t+(e-t)*r}function u(t){for(let i=0;i<t.length;i++){const n=t[i],o=t[(i+1)%t.length],a=t[(i+2)%t.length],s=[n[0]-o[0],n[1]-o[1],n[2]-o[2]],h=[o[0]-a[0],o[1]-a[1],o[2]-a[2]],l=(r=s,[(e=h)[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]),u=f(l);if(u>0)return[l[0]/u,l[1]/u,l[2]/u]}var e,r;return[1,0,0]}function f(t){return Math.hypot(t[0],t[1],t[2])}class c{constructor(t,e,r){this.gl=t;const i=this.createShader(t.VERTEX_SHADER,e),n=this.createShader(t.FRAGMENT_SHADER,r);if(this.program=t.createProgram(),t.attachShader(this.program,i),t.attachShader(this.program,n),t.linkProgram(this.program),t.deleteShader(i),t.deleteShader(n),!t.getProgramParameter(this.program,t.LINK_STATUS)){const e=t.getProgramInfoLog(this.program);throw t.deleteProgram(this.program),Error("program compilation failed: "+e)}this.vertexLocation=this.getAttribLocation("vertex")}createShader(t,e){const r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){const e=r.getShaderInfoLog(i);throw r.deleteShader(i),Error(`${t===r.FRAGMENT_SHADER?"fragment":"vertex"} shader compilation failed: ${e}`)}return i}getAttribLocation(t){return this.gl.getAttribLocation(this.program,t)}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}use(){this.gl.useProgram(this.program)}free(){this.gl.deleteProgram(this.program)}}function g(t,e,i){const n=new ImageData(t,e),o=n.data,a=t*e;let s=0;for(let t=0;t<a;t++){const e=r[parseInt(i.charAt(t),16)];o[s]=e[0],o[s+1]=e[1],o[s+2]=e[2],o[s+3]=255,s+=4}return n}const d=navigator.userAgent,m=d.includes("Safari/")&&!d.includes("Edg/");function x(t){return function(t){let e=0;return i();function r(){const r=t.charAt(e);if("{"===r)return i();if("'"===r)return n();if("-"===r||"."===r||r>="0"&&r<="9")return o();throw Error("Unkown value ("+e+'): "'+r+'" = '+r.charCodeAt(0))}function i(){e++;const i={array:[],dict:Object.create(null)};for(a();;){const n=t.charAt(e);if("}"===n){e++;break}let o;if(n>="a"&&n<="z"){let r=e;for(e++;;){if("="===t.charAt(e))break;e++}o=t.slice(r,e),e++}const s=r();null==o?i.array.push(s):i.dict[o]=s,a();","===t.charAt(e)&&(e++,a())}return i}function n(){const r=e,i=t.indexOf("'",e+1);if(i<0)throw Error("No end!!!");if(e=i+1,e===r)throw Error("!!!!");return t.slice(r+1,i)}function o(){const r=e;for(;;){const r=t.charAt(e);if(!("-"===r||"."===r||r>="0"&&r<="9"))break;e++}if(e===r)throw Error("!!!!");return Number(t.slice(r,e))}function a(){for(;;){const r=t.charAt(e);if(" "!==r&&"\n"!==r&&"\r"!==r&&"\t"!==r)break;e++}}}(t)}function _(t){let e=0,r=t.length;for(;e<t.length;){const i=t.charAt(e);if(e++,"\n"===i){r=e-1;break}if("\r"===i){r=e-1,"\n"===t.charAt(e)&&e++;break}}return[t.slice(0,r),t.slice(e)]}function p(t){if(!t.startsWith("picocad;"))throw Error("Not a picoCAD file.");const[e,r]=_(t),a=e.split(";"),s=a[1],[h,l,u]=a.slice(2).map((t=>Number(t))),[f,c]=function(t,e){const r=t.indexOf(e);return r<0?[t,""]:[t.slice(0,r),t.slice(r+e.length)]}(r,"%"),g=x(f),d=g.array.map((t=>{const e=t.dict.name,r=t.dict.pos.array,i=t.dict.rot.array,a=t.dict.v.array.map((t=>t.array)),s=t.dict.f.array.map((t=>{const e=t.array.map((t=>t-1)),r=t.dict.c,i=t.dict.uv.array,n=[];for(let t=1;t<i.length;t+=2)n.push([i[t-1],i[t]]);return new o(e,r,n,{shading:1!==t.dict.noshade,texture:1!==t.dict.notex,doubleSided:1===t.dict.dbl,renderFirst:1===t.dict.prio})}));return new n(e,r,i,a,s)}));const m=function(t){const e=Array(15360);let r,i=0;for(let n=0;n<120;n++){[r,t]=_(t);for(let t=0;t<128;t++)e[i]=Number.parseInt(r.charAt(t),16),i++}return e}(_(c)[1]);return new i(d,{name:s,alphaIndex:u,backgroundIndex:l,zoomLevel:h,texture:m})}function T(t){return(t.length<4?4278190080:function(t,e){for(let r=0;r<e;r++)t*=2;return t}(t[3],24))+(t[2]<<16)+(t[1]<<8)+t[0]}return class{constructor(t={}){this.canvas=t.canvas,null==this.canvas&&(this.canvas=document.createElement("canvas"));const e=this.gl=this.canvas.getContext("webgl",{antialias:!1,preserveDrawingBuffer:t.preserveDrawingBuffer??!1});if(this.cameraPosition={x:0,y:0,z:0},this.cameraRotation={x:0,y:0,z:0},this.cameraFOV=t.fov??90,this.loaded=!1,this.model=null,this.shading=t.shading??!0,this.renderMode=t.renderMode??"texture",this.backgroundColor=null,this.drawWireframe=t.drawWireframe??!1,this.wireframeXray=t.wireframeXray??!0,this.wireframeColor=t.wireframeColor??[1,1,1],this.tesselationCount=t.tesselationCount??3,this.lightDirection=t.lightDirection??{x:1,y:-1,z:0},this.hdOptions={shadingSteps:4,shadingColor:[.1,.1,.1]},this._passes=[],this._colorIndexTex=this._createTexture(null,this.gl.LUMINANCE,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,new Uint8Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),16,1),this._indexTex=null,this.resetLightMap(),this._programTexture=function(t){const e=new c(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec3 normal;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_normal = normal;\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\t\t\n\t\tuniform sampler2D indexTex;\n\t\tuniform sampler2D lightMap;\n\t\tuniform highp vec3 lightDir;\n\t\tuniform highp float lightMapOffset;\n\t\tuniform highp float lightMapGradient;\n\n\t\tvoid main() {\n\t\t\thighp float index = texture2D(indexTex, v_uv).r;\n\t\t\tif (index == 1.0) discard;\n\t\t\thighp float intensity = clamp(lightMapGradient * abs(dot(v_normal, lightDir)) + lightMapOffset, 0.0, 1.0);\n\t\t\tgl_FragColor = texture2D(lightMap, vec2(0.015625 + index * 15.9375 + mod(gl_FragCoord.x + gl_FragCoord.y, 2.0) * 0.03125, 1.0 - intensity));\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),normal:e.getAttribLocation("normal"),indexTex:e.getUniformLocation("indexTex"),lightMap:e.getUniformLocation("lightMap"),lightDir:e.getUniformLocation("lightDir"),mvp:e.getUniformLocation("mvp"),lightMapOffset:e.getUniformLocation("lightMapOffset"),lightMapGradient:e.getUniformLocation("lightMapGradient")}}}(e),this._programUnlitTexture=function(t){const e=new c(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D indexTex;\n\t\tuniform sampler2D lightMap;\n\n\t\tvoid main() {\n\t\t\thighp float index = texture2D(indexTex, v_uv).r;\n\t\t\tif (index == 1.0) discard;\n\t\t\tgl_FragColor = texture2D(lightMap, vec2(0.015625 + index * 15.9375, 0.0));\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),mvp:e.getUniformLocation("mvp"),indexTex:e.getUniformLocation("indexTex"),lightMap:e.getUniformLocation("lightMap")}}}(e),this._programHDTexture=function(t){const e=new c(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec3 normal;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tv_normal = normal;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\t\t\n\t\tuniform highp float lightSteps;\n\t\tuniform sampler2D mainTex;\n\t\tuniform highp vec3 lightDir;\n\t\tuniform highp vec3 lightAmbient;\n\n\t\tvoid main() {\n\t\t\thighp vec4 col = texture2D(mainTex, v_uv);\n\t\t\tif (col.a != 1.0) discard;\n\t\t\thighp float pixel = mod(gl_FragCoord.x + gl_FragCoord.y, 2.0);\n\t\t\thighp float intensity = abs(dot(v_normal, lightDir)) * 2.2 - 0.2;\n\t\t\tintensity = floor(intensity * (lightSteps + 0.5) + pixel/2.0) / lightSteps;\n\t\t\tintensity = clamp(intensity, 0.0, 1.0);\n\t\t\tgl_FragColor = vec4(mix(col.rgb * lightAmbient, col.rgb, intensity), 1.0);\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),normal:e.getAttribLocation("normal"),mvp:e.getUniformLocation("mvp"),lightSteps:e.getUniformLocation("lightSteps"),lightAmbient:e.getUniformLocation("lightAmbient"),mainTex:e.getUniformLocation("mainTex"),lightDir:e.getUniformLocation("lightDir")}}}(e),this._wireframe=null,this._programWireframe=function(t){const e=new c(t,"\n\t\tattribute vec4 vertex;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tuniform lowp vec4 color;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");return{program:e,locations:{mvp:e.getUniformLocation("mvp"),color:e.getUniformLocation("color")}}}(e),m)this._programFramebuffer=function(t){const e=new c(t,"\n\t\tattribute vec4 vertex;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tvoid main() {\n\t\t\tv_uv = 0.5 + vertex.xy * 0.5;\n\t\t\tgl_Position = vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = texture2D(mainTex, v_uv);\n\t\t}\n\t");return{program:e,locations:{mainTex:e.getUniformLocation("mainTex")}}}(e),this._depthBuffer=e.createRenderbuffer(),this._frameBuffer=e.createFramebuffer(),this._screenQuads=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._screenQuads),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);else{const t="pico-cad-viewport";this.canvas.classList.add(t),this._style=document.createElement("style"),this._style.textContent=`.${t} { image-rendering: -moz-crisp-edges; image-rendering: pixelated; }`,document.head.append(this._style)}const r=t.resolution;null==r?this.setResolution(128,128,1):this.setResolution(r.width,r.height,r.scale??1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}setResolution(t,e,r=1){if(null!=this._resolution&&this._resolution[0]===t&&this._resolution[1]===e&&this._resolution[2]===r)return;this._resolution=[t,e,r,0,0];const i=t*r,n=e*r,o=this.gl,a=this.canvas;m?(a.width=i,a.height=n,this._frameBufferTex=this._createTexture(this._frameBufferTex,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,null,t,e),o.bindRenderbuffer(o.RENDERBUFFER,this._depthBuffer),o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,t,e),o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this._frameBufferTex,0),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,this._depthBuffer)):(a.width=t,a.height=e),a.style.width=`${i}px`,a.style.height=`${n}px`}getResolution(){return{width:this._resolution[0],height:this._resolution[1],scale:this._resolution[2]}}get modelTexture(){return this.getModelTexture()}getModelTexture(){return this.model.textureAsImage(this._lightMapColors)}resetLightMap(){null!=this._lightMapTex&&this.gl.deleteTexture(this._lightMapTex),null!=this._colorLightMapTex&&this.gl.deleteTexture(this._colorLightMapTex),this._lightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,g(32,4,"00112233445566778899aabbccddeeff0010213542516d768294a9b3cdd5e8fe000011552211dd6622449933dd55889900000011110055dd1122445555112244")),this._colorLightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,g(32,7,"00112233445566778899aabbccddeeff0011223542556d768894a9bbccddeefe001122552255dd66884499bbccddeeee001021512251d56d824294b3cdd5e8e800001111221155dd22224433dd55888800001010211151d521224235d551828200000000111111551122225555112222")),this._lightMapColors=r.slice()}getPalette(){let t=this._lightMapColors.map((t=>[t[0],t[1],t[2],255]));if(null!=this.backgroundColor){const e=this.backgroundColor.map((t=>Math.floor(255.999*t)));4!=e.length&&e.push(255),t.push(e)}return t}_getLightMapColors(t){const e=Array(16);for(let r=0;r<16;r++){let i=8*r;e[r]=[t.data[i],t.data[i+1],t.data[i+2]]}return e}setLightMap(t){null!=this._lightMapTex&&this.gl.deleteTexture(this._lightMapTex),null!=this._colorLightMapTex&&this.gl.deleteTexture(this._colorLightMapTex),this._lightMapColors=this._getLightMapColors(t),this._colorLightMapTex=this._lightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t)}setTextureLightMap(t){null!=this._lightMapTex&&this.gl.deleteTexture(this._lightMapTex),this._lightMapColors=this._getLightMapColors(t),this._lightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t)}setColorLightMap(t){null!=this._colorLightMapTex&&this.gl.deleteTexture(this._colorLightMapTex),this._lightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t)}_freeMainTexture(){null!=this._indexTex&&(this.gl.deleteTexture(this._indexTex),this._indexTex=null)}setIndexTexture(t,e,i){let n,o;if(t instanceof ImageData){n=t;const e=n.width*n.height;o=new Uint8Array(e);const i=new Map(r.map((([t,e,r],i)=>[4278190080|r<<16|e<<8|t,i]))),a=new Int32Array(t.data.buffer);for(let t=0;t<e;t++){const e=a[t];o[t]=i.get(e)??0}}else{o=t instanceof Uint8Array?t:new Uint8Array(t),n=new ImageData(e,i);const a=n.data;let s=0;for(let t=0;t<i;t++)for(let t=0;t<e;t++){const[t,e,i]=r[s]??r[0];a[s++]=t,a[s++]=e,a[s++]=i,a[s++]=255}}this._freeMainTexture(),this._indexTex=this._createTexture(this._indexTex,this.gl.LUMINANCE,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,o,n.width,n.height)}setHDTexture(t){null!=t?this._hdTex=this._createTexture(this._hdTex,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t):this.removeHDTexture()}removeHDTexture(){null!=this._hdTex&&(this.gl.deleteTexture(this._hdTex),this._hdTex=null)}_createTexture(t,e,r,i,n,o,a){const s=this.gl;return null==t&&(t=s.createTexture()),s.bindTexture(s.TEXTURE_2D,t),null==o?s.texImage2D(s.TEXTURE_2D,0,e,r,i,n):s.texImage2D(s.TEXTURE_2D,0,e,o,a,0,r,i,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),t}async load(t){if("string"==typeof t)t.startsWith("picocad;")?this._loadString(t):await this._loadUrl(t);else if(t instanceof URL)await this._loadUrl(t);else if(t instanceof Blob)await this._loadBlob(t);else{if(!(t instanceof i))throw TypeError();this._loadModel(t)}return this.model}async _loadUrl(t){const e=await fetch(String(t));if(!e.ok)throw Error(`${e.status}: ${e.statusText}`);this._loadString(await e.text())}_loadBlob(t){return new Promise(((e,r)=>{if(!t.type.startsWith("text"))throw Error("picoCAD file must be a text file");const i=new FileReader;i.onload=()=>{e(this._loadString(i.result))},i.onerror=()=>{r(i.error)},i.readAsText(t)}))}_loadString(t){this._loadModel(p(t))}_loadModel(t){const e=this.gl;if(this.loaded=!1,this.model=null,this.loaded){for(const t of this._passes)t.free();this._passes=[],this._wireframe.free(),e.deleteTexture(this._indexTex),this._indexTex=null}const r=h(e,t,this.tesselationCount);this._passes=r.passes,this._wireframe=r.wireframe,this._indexTex=this._createTexture(this._indexTex,e.LUMINANCE,e.LUMINANCE,e.UNSIGNED_BYTE,new Uint8Array(r.textureIndices),128,128),this.loaded=!0,this.model=t}draw(){const e="none"!==this.renderMode,r="color"===this.renderMode;if(!this.loaded||!e&&!this.drawWireframe)return;const i=this.gl,n=this.canvas;if(m?(i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.viewport(0,0,this._resolution[0],this._resolution[1])):i.viewport(0,0,n.width,n.height),null==this.backgroundColor){const t=this._lightMapColors[this.model.backgroundIndex];i.clearColor(t[0]/255,t[1]/255,t[2]/255,1)}else i.clearColor(this.backgroundColor[0],this.backgroundColor[1],this.backgroundColor[2],this.backgroundColor[3]??1);i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const o=(a=new t(16),t!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=0,a[12]=0,a[13]=0,a[14]=0),a[0]=1,a[5]=1,a[10]=1,a[15]=1,a);var a;!function(t,e,r,i,n){var o,a=1/Math.tan(e/2);t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=n&&n!==1/0?(o=1/(i-n),t[10]=(n+i)*o,t[14]=2*n*i*o):(t[10]=-1,t[14]=-2*i)}(o,this.cameraFOV*Math.PI/180,this._resolution[0]/this._resolution[1],.1,400),function(t,e,r){var i=Math.sin(r),n=Math.cos(r),o=e[4],a=e[5],s=e[6],h=e[7],l=e[8],u=e[9],f=e[10],c=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*n+l*i,t[5]=a*n+u*i,t[6]=s*n+f*i,t[7]=h*n+c*i,t[8]=l*n-o*i,t[9]=u*n-a*i,t[10]=f*n-s*i,t[11]=c*n-h*i}(o,o,this.cameraRotation.x),function(t,e,r){var i=Math.sin(r),n=Math.cos(r),o=e[0],a=e[1],s=e[2],h=e[3],l=e[8],u=e[9],f=e[10],c=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*n-l*i,t[1]=a*n-u*i,t[2]=s*n-f*i,t[3]=h*n-c*i,t[8]=o*i+l*n,t[9]=a*i+u*n,t[10]=s*i+f*n,t[11]=h*i+c*n}(o,o,this.cameraRotation.y),function(t,e,r){var i=Math.sin(r),n=Math.cos(r),o=e[0],a=e[1],s=e[2],h=e[3],l=e[4],u=e[5],f=e[6],c=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*n+l*i,t[1]=a*n+u*i,t[2]=s*n+f*i,t[3]=h*n+c*i,t[4]=l*n-o*i,t[5]=u*n-a*i,t[6]=f*n-s*i,t[7]=c*n-h*i}(o,o,this.cameraRotation.z),function(t,e,r){var i,n,o,a,s,h,l,u,f,c,g,d,m=r[0],x=r[1],_=r[2];e===t?(t[12]=e[0]*m+e[4]*x+e[8]*_+e[12],t[13]=e[1]*m+e[5]*x+e[9]*_+e[13],t[14]=e[2]*m+e[6]*x+e[10]*_+e[14],t[15]=e[3]*m+e[7]*x+e[11]*_+e[15]):(i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],h=e[5],l=e[6],u=e[7],f=e[8],c=e[9],g=e[10],d=e[11],t[0]=i,t[1]=n,t[2]=o,t[3]=a,t[4]=s,t[5]=h,t[6]=l,t[7]=u,t[8]=f,t[9]=c,t[10]=g,t[11]=d,t[12]=i*m+s*x+f*_+e[12],t[13]=n*m+h*x+c*_+e[13],t[14]=o*m+l*x+g*_+e[14],t[15]=a*m+u*x+d*_+e[15])}(o,o,[this.cameraPosition.x,this.cameraPosition.y,this.cameraPosition.z]);const s=function(t){let e=Math.hypot(t.x,t.y,t.z);0===e&&(e=1);return{x:t.x/e,y:t.y/e,z:t.z/e}}(this.lightDirection);if(e)for(const t of this._passes){if(t.clearDepth&&i.clear(i.DEPTH_BUFFER_BIT),t.isEmpty())continue;const e=r||!t.texture,n=null==this._hdTex||e?this.shading&&t.shading?this._programTexture:this._programUnlitTexture:this._programHDTexture;n.program.use(),i.uniformMatrix4fv(n.locations.mvp,!1,o),i.bindBuffer(i.ARRAY_BUFFER,t.vertexBuffer),i.vertexAttribPointer(n.program.vertexLocation,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(n.program.vertexLocation),i.bindBuffer(i.ARRAY_BUFFER,e?t.colorUVBuffer:t.uvBuffer),i.vertexAttribPointer(n.locations.uv,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(n.locations.uv),n===this._programUnlitTexture?(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e?this._colorIndexTex:this._indexTex),i.uniform1i(n.locations.indexTex,0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,e?this._colorLightMapTex:this._lightMapTex),i.uniform1i(n.locations.lightMap,1)):n===this._programTexture?(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e?this._colorIndexTex:this._indexTex),i.uniform1i(n.locations.indexTex,0),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,e?this._colorLightMapTex:this._lightMapTex),i.uniform1i(n.locations.lightMap,1),i.uniform1f(n.locations.lightMapOffset,e?-.316326530612245:-.3571428571428572),i.uniform1f(n.locations.lightMapGradient,e?1.63265306122449:2.857142857142857),i.uniform3f(n.locations.lightDir,s.x,s.y,s.z),i.bindBuffer(i.ARRAY_BUFFER,t.normalBuffer),i.vertexAttribPointer(n.locations.normal,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(n.locations.normal)):n===this._programHDTexture&&(i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._hdTex),i.uniform1i(n.locations.mainTex,0),i.uniform3f(n.locations.lightDir,s.x,s.y,s.z),i.uniform1f(n.locations.lightSteps,this.hdOptions.shadingSteps),i.uniform3f(n.locations.lightAmbient,this.hdOptions.shadingColor[0],this.hdOptions.shadingColor[1],this.hdOptions.shadingColor[2]),i.bindBuffer(i.ARRAY_BUFFER,t.normalBuffer),i.vertexAttribPointer(n.locations.normal,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(n.locations.normal)),t.cull?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.triangleBuffer),i.drawElements(i.TRIANGLES,t.vertexCount,i.UNSIGNED_SHORT,0),i.disableVertexAttribArray(n.program.vertexLocation),i.disableVertexAttribArray(n.locations.uv),n===this._programTexture&&i.disableVertexAttribArray(n.locations.normal)}this.drawWireframe&&(e&&this.wireframeXray&&i.clear(i.DEPTH_BUFFER_BIT),this._programWireframe.program.use(),i.uniformMatrix4fv(this._programWireframe.locations.mvp,!1,o),i.uniform4fv(this._programWireframe.locations.color,[this.wireframeColor[0],this.wireframeColor[1],this.wireframeColor[2],1]),i.bindBuffer(i.ARRAY_BUFFER,this._wireframe.vertexBuffer),i.vertexAttribPointer(this._programWireframe.program.vertexLocation,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this._programWireframe.program.vertexLocation),i.drawArrays(i.LINES,0,this._wireframe.vertexCount)),m&&(i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,n.width,n.height),this._programFramebuffer.program.use(),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this._frameBufferTex),i.uniform1i(this._programFramebuffer.locations.mainTex,0),i.bindBuffer(i.ARRAY_BUFFER,this._screenQuads),i.vertexAttribPointer(this._programFramebuffer.program.vertexLocation,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this._programFramebuffer.program.vertexLocation),i.drawArrays(i.TRIANGLES,0,6))}startDrawLoop(t,e){let r=performance.now(),i=r;const n=()=>{if(null!=t){const e=performance.now();t((e-r)/1e3),r=e}if(this.draw(),null!=e){const t=performance.now();e((t-i)/1e3),i=t}this._rafID=requestAnimationFrame(n)};this._rafID=requestAnimationFrame(n)}stopDrawLoop(){null!=this._rafID&&cancelAnimationFrame(this._rafID)}getCameraRight(){return this._transformDirection(1,0,0)}getCameraUp(){return this._transformDirection(0,-1,0)}getCameraForward(){return this._transformDirection(0,0,-1)}setLightDirectionFromCamera(){const t=this.getCameraUp(),e=this.getCameraForward();this.lightDirection={x:e.x-.4*t.x,y:e.y-.4*t.y,z:e.z-.4*t.z}}getTextureColorCount(t=!1){const e=Array(16).fill(!1);let r=0;for(const t of this.model.texture)e[t]||(e[t]=!0,r++);return r}getTriangleCount(){let t=0;for(const e of this._passes)t+=Math.floor(e.vertexCount/3);return t}getDrawCallCount(){let t=0;for(const e of this._passes)e.isEmpty()||t++;return this.drawWireframe&&t++,m&&t++,t}_transformDirection(t,r,i){const n=e();!function(t,e,r,i){t[0]=e,t[1]=r,t[2]=i}(n,t,r,i);const o=((a=e())[0]=0,a[1]=0,a[2]=0,a);var a;return function(t,e,r,i){var n=[],o=[];n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(n,n,o,Math.PI+this.cameraRotation.x),function(t,e,r,i){var n=[],o=[];n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(n,n,o,this.cameraRotation.y),function(t,e,r,i){var n=[],o=[];n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(n,n,o,Math.PI+this.cameraRotation.z),{x:n[0],y:n[1],z:n[2]}}setTurntableCamera(t,e,r,i={x:0,y:1.5,z:0}){const n=Math.PI-e;r=-r,this.cameraPosition={x:t*Math.cos(r)*Math.sin(n)-i.x,y:t*Math.sin(r)-i.y,z:t*Math.cos(r)*Math.cos(n)-i.z},this.cameraRotation={y:e,x:-r,z:0}}getPixelIndices(t=1){const e=this.gl,[r,i]=this._resolution,n=r*i,o=r*t,a=o*t,s=t*t;t=Math.max(1,Math.floor(t));const h=new Uint8Array(4*n);m&&e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.readPixels(0,0,r,i,e.RGBA,e.UNSIGNED_BYTE,h),m&&e.bindFramebuffer(e.FRAMEBUFFER,null);const l=new Map(this.getPalette().map(((t,e)=>[T(t),e]))),u=new Uint32Array(h.buffer),f=new Uint8Array(n*s);let c=n-r,g=0;for(let e=0;e<i;e++){let e=c,i=g;for(let n=0;n<r;n++){const r=u[e],n=l.get(r)??0;if(1===t)f[i]=n;else{let e=i;for(let r=0;r<t;r++){for(let r=0;r<t;r++)f[e+r]=n;e+=o}}i+=t,e++}c-=r,g+=a}return f}free(){const t=this.gl;this.stopDrawLoop();for(const t of this._passes)t.free();this._passes=[],t.deleteTexture(this._lightMapTex),t.deleteTexture(this._colorLightMapTex),t.deleteTexture(this._indexTex),this._lightMapTex=null,this._colorLightMapTex=null,this._indexTex=null,this._programTexture.program.free(),this._programWireframe.program.free(),this._programTexture=null,this._programWireframe=null,m&&(t.deleteFramebuffer(this._frameBuffer),t.deleteTexture(this._frameBufferTex),t.deleteBuffer(this._screenQuads),t.deleteRenderbuffer(this._depthBuffer),this._programFramebuffer.program.free(),this._frameBuffer=null,this._frameBufferTex=null,this._screenQuads=null,this._depthBuffer=null,this._programFramebuffer=null)}}}();
